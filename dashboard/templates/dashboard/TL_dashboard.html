<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TL Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'dashboard/css/TL_dashboard.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <h1 class="logo">EMAIL MANAGER</h1>
        <nav class="nav-links">
    <a href="{% url 'tl_dashboard' %}" class="nav-link active"> Dashboard</a>
    <a href="{% url 'closed_emails_page' %}" class="nav-link">Closed Emails</a>
    <a href="{% url 'logout' %}" class="nav-link">Logout</a>
</nav>
    </header>
    <main class="main-content">
        <div class="dashboard-container">
            <section class="email-table-section">
                <h2>TL Email List</h2>
                <div id="message" style="text-align: center; margin-top: 1rem;"></div>
                <div class="table-controls">
                    <div class="search-container">
                        <input type="text" id="search-bar" class="search-bar" placeholder="Search ID..." oninput="searchEmails()">
                        <select id="status-filter" class="status-filter" onchange="searchEmails()">
                            <option value="">All</option>
                            <option value="working">Working</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: center;">
                    <div style="flex: 1; text-align: center;">
                        <button id="delete-all-btn" class="btn btn-danger" onclick="deleteAllEmails()">Delete All</button>
                    </div>
                    <div style="flex: 0;">
                        <button id="export-button" class="btn btn-primary">Export</button>
                        <form method="post" enctype="multipart/form-data" action="{% url 'import_tl_emails' %}" style="display: inline;">
    {% csrf_token %}
    <input type="file" name="excel_file" accept=".xlsx,.xls" style="display: none;" id="import-file">
    <label for="import-file" class="btn btn-secondary">Import</label>
</form>
                    </div>
                </div>
                <table class="email-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Gmail ID</th>
                            <th>Password</th>
                            <th>Recovery Email</th>
                            <th>Provider</th>
                            <th>New Password</th> <!-- Replaced Price -->
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="email-table-body"></tbody>
                </table>
                <div class="pagination">
                    <button id="prev-btn" onclick="changePage(-1)" disabled>â—€</button>
                    <span id="page-info"></span>
                    <button id="next-btn" onclick="changePage(1)" disabled>â–¶</button>
                </div>
                <button id="save-button" onclick="saveStatuses()">Save</button>
            </section>
        </div>
    </main>
    <footer class="footer">
        <p>Â© 2025 Email Manager. All rights reserved.</p>
    </footer>
    <form style="display: none;" id="csrf-form">{% csrf_token %}</form>
<script>
    const emailTableBody = document.getElementById('email-table-body');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInfo = document.getElementById('page-info');
    const searchBar = document.getElementById('search-bar');
    const statusFilter = document.getElementById('status-filter');
    const messageDiv = document.getElementById('message');
    const exportButton = document.getElementById('export-button');
    let currentPage = 1;
    let emailStatuses = {};

    function fetchEmails(searchId = '', status = '') {
        let url = `/tl-dashboard-data/?page=${currentPage}`;
        if (searchId) url += `&search_id=${searchId}`;
        if (status && status !== '') url += `&status=${encodeURIComponent(status)}`;
        console.log('Fetching emails with URL:', url);
        fetch(url, {
            method: 'GET',
            headers: { 'X-CSRFToken': getCookie('csrftoken') || document.getElementById('csrf-form').querySelector('[name=csrfmiddlewaretoken]').value }
        })
        .then(response => {
            if (!response.ok) throw new Error(`Network response was not ok, status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            emailTableBody.innerHTML = '';
            console.log('Fetched TL data:', data);
            if (data.error || data.message) {
                messageDiv.textContent = data.error || data.message;
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                pageInfo.textContent = '';
            } else {
                messageDiv.textContent = '';
                if (data.emails && data.emails.length > 0) {
                    data.emails.forEach(email => {
                        const tr = document.createElement('tr');
                        const currentStatus = email.status || 'working';
                        const emailId = email.id || 0;
                        if (!emailId) console.warn(`Missing ID for email ${email.gmail_id}`);
                        tr.innerHTML = `
                            <td>${email.source_file_id || 'N/A'}</td>
                            <td>${email.gmail_id || ''}</td>
                            <td>${email.password || ''}</td>
                            <td>${email.recovery_email || ''}</td>
                            <td>${email.provider || 'gmail'}</td>
                            <td>${email.new_password || ''}</td> <!-- Show empty string instead of N/A -->
                            <td>
                                <select class="status-select" data-id="${emailId}" onchange="updateStatus(${emailId}, this.value)">
                                    <option value="working" ${currentStatus === 'working' ? 'selected' : ''}>Working</option>
                                    <option value="closed" ${currentStatus === 'closed' ? 'selected' : ''}>Closed</option>
                                </select>
                            </td>
                            <td><button class="btn-delete" data-id="${emailId}" onclick="deleteEmail(${emailId})">ðŸ—‘</button></td>
                        `;
                        emailTableBody.appendChild(tr);
                    });
                    pageInfo.textContent = `Page ${data.current_page} of ${data.total_pages}`;
                    prevBtn.disabled = !data.has_prev;
                    nextBtn.disabled = !data.has_next;
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="8" class="no-data">No emails available for your provider.</td>';
                    emailTableBody.appendChild(tr);
                    pageInfo.textContent = 'Page 1 of 1';
                    prevBtn.disabled = true;
                    nextBtn.disabled = true;
                }
            }
        })
        .catch(error => {
            console.error('Error fetching TL emails:', error);
            messageDiv.textContent = 'An error occurred. Check console for details.';
        });
    }

    function updateStatus(emailId, newStatus) {
        console.log(`Attempting to update status for email ID ${emailId} to ${newStatus}`);
        if (!emailId || emailId === 0) {
            console.error('Invalid or missing email ID:', emailId);
            return;
        }
        const select = document.querySelector(`.status-select[data-id="${emailId}"]`);
        if (!select) {
            console.error(`Select element not found for email ID ${emailId}`);
            return;
        }
        emailStatuses[emailId] = newStatus;
        console.log('Updated emailStatuses:', emailStatuses);
        select.value = newStatus;
        console.log(`Dropdown updated to ${newStatus} for email ID ${emailId}`);
    }

    function saveStatuses() {
        console.log('Save button clicked, emailStatuses:', emailStatuses);
        if (Object.keys(emailStatuses).length === 0) {
            alert('No status changes to save.');
            return;
        }
        fetch('/update-tl-email-status/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken') || document.getElementById('csrf-form').querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ statuses: emailStatuses })
        })
        .then(response => {
            console.log('Fetch response status:', response.status);
            if (!response.ok) throw new Error(`Network response was not ok, status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('Fetch response data:', data);
            if (data.message) {
                alert(data.message);
                emailStatuses = {};
                fetchEmails(searchBar.value.trim(), statusFilter.value);
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error saving TL statuses:', error);
            messageDiv.textContent = 'An error occurred. Check console for details.';
        });
    }

    function searchEmails() {
        const searchId = searchBar.value.trim();
        const status = statusFilter.value;
        console.log('Search triggered with searchId:', searchId, 'status:', status);
        currentPage = 1;
        fetchEmails(searchId, status);
    }

    function changePage(delta) {
        currentPage += delta;
        if (currentPage < 1) currentPage = 1;
        fetchEmails(searchBar.value.trim(), statusFilter.value);
    }

    function deleteEmail(emailId) {
        if (!confirm('Are you sure you want to delete this email?')) return;
        fetch(`/delete-tl-email/${emailId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken') || document.getElementById('csrf-form').querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.message) fetchEmails(searchBar.value.trim(), statusFilter.value);
            else if (data.error) alert(data.error);
        })
        .catch(error => {
            console.error('Error deleting TL email:', error);
            messageDiv.textContent = 'An error occurred. Check console for details.';
        });
    }

    function deleteAllEmails() {
        if (!confirm('Are you sure you want to delete ALL emails assigned to you? This action cannot be undone!')) return;
        fetch('/delete-all-tl-emails/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken') || document.getElementById('csrf-form').querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.message) {
                alert(data.message);
                fetchEmails(searchBar.value.trim(), statusFilter.value);
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting all TL emails:', error);
            messageDiv.textContent = 'An error occurred. Check console for details.';
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.querySelector('#import-file').addEventListener('change', function(e) {
        const form = document.querySelector('form[enctype="multipart/form-data"]');
        const formData = new FormData(form);
        fetch('{% url "import_tl_emails" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken') || document.getElementById('csrf-form').querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.message) {
                alert(data.message);
                fetchEmails(searchBar.value.trim(), statusFilter.value);
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error importing TL emails:', error);
            messageDiv.textContent = 'An error occurred. Check console for details.';
        })
        .finally(() => {
            form.reset(); // Clear the file input
        });
    });

    exportButton.addEventListener('click', function() {
        window.location.href = '{% url "export_tl_emails" %}';
    });

    document.addEventListener('DOMContentLoaded', () => fetchEmails());
</script>
</body>
</html>